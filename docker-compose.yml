version: '3.8'

services:
  # Backend Python (RAG con Gemini + Qdrant)
  backend:
    build:
      context: ./python/backend
      dockerfile: Dockerfile
    image: chatbot-backend:latest
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION}
    volumes:
      - backend_pdfs:/app/pdf_files
      - backend_cache:/app/cache
    networks:
      - chatbot_internal
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Frontend Next.js
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    image: chatbot-frontend:latest
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - PYTHON_BACKEND_URL=${PYTHON_BACKEND_URL}
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME}
      - DEFAULT_LOCALE=${DEFAULT_LOCALE}
      - SUPPORTED_LOCALES=${SUPPORTED_LOCALES}
    depends_on:
      - backend
    networks:
      - chatbot_internal
      - traefik_public
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.escuelasabatica-https.rule=Host(`escuelasabatica.sages.icu`)"
        - "traefik.http.routers.escuelasabatica-https.entrypoints=websecure"
        - "traefik.http.routers.escuelasabatica-https.tls.certresolver=le"
        - "traefik.http.routers.escuelasabatica-https.tls=true"
        - "traefik.http.services.escuelasabatica-service.loadbalancer.server.port=3000"
        - "traefik.http.routers.escuelasabatica-https.service=escuelasabatica-service"

volumes:
  backend_pdfs:
  backend_cache:

networks:
  chatbot_internal:
  traefik_public:
    external: true
